{% extends "base.html" %}

{% block title %}출석 체크 - WCheck{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance.css') }}">
{% endblock %}

{% block header %}
<header class="full-title-header">
    <div class="title-wrap">
        <h1 class="page-title">{{ username }}님 출석 체크</h1>
        <div class="server-time">
            <span class="server-time-label">현재 시간:</span>
            <span id="serverNow" data-server-iso="{{ server_now_iso }}" class="server-time-value">
                {{ server_now_fmt }}
            </span>
            <span id="serverWeekday" class="badge badge-info"></span>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="hint alert alert-info">
        <span>ℹ️</span>
        <span>수업 시작 <b>10분 전 ~ 10분 후</b>에만 출석이 가능합니다.</span>
    </div>

    <div class="att-table-wrapper card fade-in">
        <table class="att-table table">
            <thead>
                <tr>
                    <th class="col-subject">과목</th>
                    <th class="col-professor">교수</th>
                    <th class="col-location">강의실</th>
                    <th class="col-time">시간</th>
                    <th class="col-action">상태 / 출석</th>
                </tr>
            </thead>
            <tbody>
                {% if today_classes %}
                    {% for cls in today_classes %}
                        <tr class="att-row" data-schedule-id="{{ cls.schedule_id }}" data-window-open="{{ '1' if cls.window_open else '0' }}">
                            <td class="sbj">
                                <div class="subject-name">{{ cls.subject_name }}</div>
                            </td>
                            <td>{{ cls.professor_name or '-' }}</td>
                            <td>{{ cls.location or '-' }}</td>
                            <td class="time-cell-content">
                                <div class="time-badge">{{ cls.start_time_str }} ~ {{ cls.end_time_str }}</div>
                                <div class="window-range">
                                    <span class="window-icon">✓</span> 가능: {{ cls.window_from_str }} ~ {{ cls.window_to_str }}
                                </div>
                            </td>
                            <td class="action-cell">
                                <span class="badge {{ 'badge-success' if cls.status == '출석완료' else 'badge-neutral' }}">
                                    {{ cls.status }}
                                </span>
                                {% if cls.window_open and cls.status != '출석완료' %}
                                    <form class="att-form" method="POST" action="{{ url_for('attendance.check_attendance') }}">
                                        <input type="hidden" name="schedule_id" value="{{ cls.schedule_id }}">
                                        <button type="submit" class="btn btn-success btn-sm">출석하기</button>
                                    </form>
                                {% else %}
                                    <button class="btn btn-sm disabled" disabled>출석 불가</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="empty">오늘 예정된 수업이 없습니다.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeSpan = document.getElementById('serverNow');
        const weekSpan = document.getElementById('serverWeekday');
        const iso = timeSpan.dataset.serverIso;
        let now = iso ? new Date(iso) : new Date();

        const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
        const pad2 = n => String(n).padStart(2, '0');

        const formatTime = (d) => {
            const yyyy = d.getFullYear();
            const mm = pad2(d.getMonth() + 1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mi = pad2(d.getMinutes());
            const ss = pad2(d.getSeconds());
            return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        };

        function render() {
            timeSpan.textContent = formatTime(now);
            weekSpan.textContent = `(${weekdays[now.getDay()]})`;
        }

        render();
        setInterval(() => {
            now.setSeconds(now.getSeconds() + 1);
            render();
        }, 1000);

        setInterval(async () => {
            try {
                const res = await fetch("/api/server_time");
                if (!res.ok) return;
                const data = await res.json();
                now = new Date(data.server_time_iso);
                render();
            } catch (err) {
                console.warn("서버 시간 동기화 실패:", err);
            }
        }, 600000);
    });
</script>
{% endblock %}
