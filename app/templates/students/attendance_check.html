{% extends "base.html" %}

{% block title %}출석 체크 - WCheck{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance.css') }}">
{% endblock %}

{% block header %}
<header class="full-title-header">
    <div class="title-wrap">
        <h1 class="page-title">{{ username }}님 출석 체크</h1>
        <div class="server-time">
            <span class="server-time-label">현재 시간:</span>
            <span id="serverNow" data-server-iso="{{ server_now_iso }}" class="server-time-value">
                {{ server_now_fmt }}
            </span>
            <span id="serverWeekday" class="badge badge-info"></span>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="hint alert alert-info">
        <svg class="icon-inline" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>수업 시작 <b>10분 전 ~ 10분 후</b>에만 출석이 가능합니다.</span>
    </div>

    <div class="attendance-cards-wrapper fade-in">
        {% if today_classes %}
            {% for cls in today_classes %}
                <div class="attendance-card 
                    {% if cls.status == '출석완료' %}status-present
                    {% elif cls.status == '지각' %}status-late
                    {% elif cls.status == '결석' %}status-absent
                    {% elif cls.window_open %}status-available
                    {% else %}status-unavailable{% endif %}"
                    data-schedule-id="{{ cls.schedule_id }}" 
                    data-window-open="{{ '1' if cls.window_open else '0' }}"
                    data-status="{{ cls.status }}">
                    <div class="attendance-card-content">
                        <div class="card-left">
                            <div class="subject-info">
                                <h3 class="subject-name">{{ cls.subject_name }}</h3>
                                <div class="class-meta">
                                    <span class="meta-item">
                                        <span class="meta-label">교수:</span>
                                        <span class="meta-value">{{ cls.professor_name or '-' }}</span>
                                    </span>
                                    <span class="meta-divider">•</span>
                                    <span class="meta-item">
                                        <span class="meta-label">강의실:</span>
                                        <span class="meta-value">{{ cls.location or '-' }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-center">
                            <div class="time-info">
                                <div class="time-badge">
                                    <svg class="time-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span class="time-text">{{ cls.start_time_str }} ~ {{ cls.end_time_str }}</span>
                                </div>
                                <div class="window-range">
                                    <svg class="window-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>출석 가능: {{ cls.window_from_str }} ~ {{ cls.window_to_str }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="status-section">
                                <span class="status-badge 
                                    {% if cls.status == '출석완료' %}badge-success
                                    {% elif cls.status == '지각' %}badge-warning
                                    {% elif cls.status == '결석' %}badge-danger
                                    {% else %}badge-neutral{% endif %}">
                                    {{ cls.status }}
                                </span>
                                {% if cls.window_open and cls.status != '출석완료' %}
                                    <form class="att-form" method="POST" action="{{ url_for('attendance.check_attendance') }}">
                                        <input type="hidden" name="schedule_id" value="{{ cls.schedule_id }}">
                                        <button type="submit" class="btn btn-success btn-sm">출석하기</button>
                                    </form>
                                {% else %}
                                    <button class="btn btn-sm disabled" disabled>출석 불가</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-attendance">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: var(--spacing-md);">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <p class="empty-message-attendance">오늘 예정된 수업이 없습니다.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeSpan = document.getElementById('serverNow');
        const weekSpan = document.getElementById('serverWeekday');
        const iso = timeSpan.dataset.serverIso;
        let now = iso ? new Date(iso) : new Date();

        const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
        const pad2 = n => String(n).padStart(2, '0');

        const formatTime = (d) => {
            const yyyy = d.getFullYear();
            const mm = pad2(d.getMonth() + 1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mi = pad2(d.getMinutes());
            const ss = pad2(d.getSeconds());
            return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        };

        function render() {
            timeSpan.textContent = formatTime(now);
            weekSpan.textContent = `(${weekdays[now.getDay()]})`;
        }

        render();
        setInterval(() => {
            now.setSeconds(now.getSeconds() + 1);
            render();
        }, 1000);

        setInterval(async () => {
            try {
                const res = await fetch("/api/server_time");
                if (!res.ok) return;
                const data = await res.json();
                now = new Date(data.server_time_iso);
                render();
            } catch (err) {
                console.warn("서버 시간 동기화 실패:", err);
            }
        }, 600000);
    });
</script>
{% endblock %}
