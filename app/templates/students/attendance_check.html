{% extends "base.html" %}

{% block title %}ì¶œì„ ì²´í¬ - WCheck{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance.css') }}">
{% endblock %}

{% block header %}
<header class="full-title-header">
    <div class="title-wrap">
        <h1 class="page-title">{{ username }}ë‹˜ ì¶œì„ ì²´í¬</h1>
        <div class="server-time">
            <span class="server-time-label">í˜„ì¬ ì‹œê°„:</span>
            <span id="serverNow" data-server-iso="{{ server_now_iso }}" class="server-time-value">
                {{ server_now_fmt }}
            </span>
            <span id="serverWeekday" class="badge badge-info"></span>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="hint alert alert-info">
        <span>â„¹ï¸</span>
        <span>ìˆ˜ì—… ì‹œì‘ <b>10ë¶„ ì „ ~ 10ë¶„ í›„</b>ì—ë§Œ ì¶œì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
    </div>

    <div class="attendance-cards-wrapper fade-in">
        {% if today_classes %}
            {% for cls in today_classes %}
                <div class="attendance-card 
                    {% if cls.status == 'ì¶œì„ì™„ë£Œ' %}status-present
                    {% elif cls.status == 'ì§€ê°' %}status-late
                    {% elif cls.status == 'ê²°ì„' %}status-absent
                    {% elif cls.window_open %}status-available
                    {% else %}status-unavailable{% endif %}"
                    data-schedule-id="{{ cls.schedule_id }}" 
                    data-window-open="{{ '1' if cls.window_open else '0' }}"
                    data-status="{{ cls.status }}">
                    <div class="attendance-card-content">
                        <div class="card-left">
                            <div class="subject-info">
                                <h3 class="subject-name">{{ cls.subject_name }}</h3>
                                <div class="class-meta">
                                    <span class="meta-item">
                                        <span class="meta-label">êµìˆ˜:</span>
                                        <span class="meta-value">{{ cls.professor_name or '-' }}</span>
                                    </span>
                                    <span class="meta-divider">â€¢</span>
                                    <span class="meta-item">
                                        <span class="meta-label">ê°•ì˜ì‹¤:</span>
                                        <span class="meta-value">{{ cls.location or '-' }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-center">
                            <div class="time-info">
                                <div class="time-badge">
                                    <span class="time-icon">ğŸ•</span>
                                    <span class="time-text">{{ cls.start_time_str }} ~ {{ cls.end_time_str }}</span>
                                </div>
                                <div class="window-range">
                                    <span class="window-icon">âœ“</span>
                                    <span>ì¶œì„ ê°€ëŠ¥: {{ cls.window_from_str }} ~ {{ cls.window_to_str }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="status-section">
                                <span class="status-badge 
                                    {% if cls.status == 'ì¶œì„ì™„ë£Œ' %}badge-success
                                    {% elif cls.status == 'ì§€ê°' %}badge-warning
                                    {% elif cls.status == 'ê²°ì„' %}badge-danger
                                    {% else %}badge-neutral{% endif %}">
                                    {{ cls.status }}
                                </span>
                                {% if cls.window_open and cls.status != 'ì¶œì„ì™„ë£Œ' %}
                                    <form class="att-form" method="POST" action="{{ url_for('attendance.check_attendance') }}">
                                        <input type="hidden" name="schedule_id" value="{{ cls.schedule_id }}">
                                        <button type="submit" class="btn btn-success btn-sm">ì¶œì„í•˜ê¸°</button>
                                    </form>
                                {% else %}
                                    <button class="btn btn-sm disabled" disabled>ì¶œì„ ë¶ˆê°€</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p class="empty-message">ì˜¤ëŠ˜ ì˜ˆì •ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeSpan = document.getElementById('serverNow');
        const weekSpan = document.getElementById('serverWeekday');
        const iso = timeSpan.dataset.serverIso;
        let now = iso ? new Date(iso) : new Date();

        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const pad2 = n => String(n).padStart(2, '0');

        const formatTime = (d) => {
            const yyyy = d.getFullYear();
            const mm = pad2(d.getMonth() + 1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mi = pad2(d.getMinutes());
            const ss = pad2(d.getSeconds());
            return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        };

        function render() {
            timeSpan.textContent = formatTime(now);
            weekSpan.textContent = `(${weekdays[now.getDay()]})`;
        }

        render();
        setInterval(() => {
            now.setSeconds(now.getSeconds() + 1);
            render();
        }, 1000);

        setInterval(async () => {
            try {
                const res = await fetch("/api/server_time");
                if (!res.ok) return;
                const data = await res.json();
                now = new Date(data.server_time_iso);
                render();
            } catch (err) {
                console.warn("ì„œë²„ ì‹œê°„ ë™ê¸°í™” ì‹¤íŒ¨:", err);
            }
        }, 600000);
    });
</script>
{% endblock %}
