{% extends "base.html" %}

{% block title %}출석 관리 - WCheck{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance_cards.css') }}">
{% endblock %}

{% block header %}
<header class="full-title-header">
    <div class="title-wrap">
        <h1 class="page-title">{{ username }}님 출석 관리</h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="attendance-calculation-hint">
        <span class="calculation-link" id="show-calculation-modal">
            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            출석률 계산 방식
        </span>
    </div>

    <!-- 출석률 계산 방식 모달 -->
    <div id="calculation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg class="icon-inline" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    출석률 계산 방식
                </h2>
                <button class="modal-close" id="close-calculation-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calculation-formula">
                    <h3>계산 공식</h3>
                    <div class="formula-box">
                        출석률 = <span class="formula-numerator">(출석 + 지각)</span> / <span class="formula-denominator">실제 진행된 수업 (휴강 제외)</span> × 100%
                    </div>
                </div>
                <div class="calculation-explanation">
                    <h3>설명</h3>
                    <ul class="explanation-list">
                        <li><strong>출석률은 오늘까지 진행된 수업 기준</strong>으로 계산됩니다.</li>
                        <li><strong>지각도 출석으로 간주</strong>됩니다.</li>
                        <li><strong>휴강 수업은 출석률 계산에서 제외</strong>됩니다.</li>
                        <li><strong>출석 기록이 없는 수업은 결석으로 간주</strong>됩니다.</li>
                        <li><strong>분모는 실제로 진행된 수업만 포함</strong>됩니다 (휴강 제외).</li>
                    </ul>
                </div>
                <div class="calculation-example">
                    <h3>예시</h3>
                    <div class="example-box">
                        <p>오늘까지 진행된 수업: 10개 (휴강 1개 포함)</p>
                        <p>실제 진행된 수업: 9개 (휴강 제외)</p>
                        <p>출석: 5개, 지각: 2개, 결석: 1개, 출석기록없음: 1개</p>
                        <p class="example-result">
                            출석률 = (5 + 2) / 9 × 100% = 7 / 9 × 100% = <strong>77.8%</strong>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-close" id="close-calculation-modal-btn">확인</button>
            </div>
        </div>
    </div>

    {% if enrolled_subjects %}
        <div class="attendance-cards-container fade-in">
            {% for subject in enrolled_subjects %}
                <div class="attendance-card status-{{ 'safe' if subject.status_color == 'green' else 'warning' if subject.status_color == 'orange' else 'danger' }} clickable-row" 
                     data-subject-id="{{ subject.subject_id }}">
                    <div class="card-header">
                        <h3 class="card-subject-name">{{ subject.subject_name }}</h3>
                        <p class="card-professor-name">{{ subject.professor_name or '교수 정보 없음' }}</p>
                    </div>
                    <div class="card-body">
                        <div class="card-percentage">
                            <span class="card-percentage-value">{{ subject.attendance_percentage }}</span>
                            <span class="card-percentage-unit">%</span>
                            <span class="card-status-badge">{{ subject.status_text }}</span>
                        </div>
                        <div class="card-progress-container">
                            <div class="card-progress-bar">
                                <div class="card-progress-fill" style="width: {{ subject.attendance_percentage }}%;"></div>
                            </div>
                            <div class="card-stats">
                                <div class="card-stat-item">
                                    <span class="card-stat-label">출석</span>
                                    <span class="card-stat-value">{{ subject.present_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">지각</span>
                                    <span class="card-stat-value">{{ subject.late_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">결석</span>
                                    <span class="card-stat-value">{{ subject.absent_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">총 수업</span>
                                    <span class="card-stat-value">{{ subject.total_sessions }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state-attendance">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: var(--spacing-md);">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            <p class="empty-message-attendance">수강 중인 과목이 없습니다.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.clickable-row').forEach(card => {
        card.addEventListener('click', () => {
            const subjectId = card.dataset.subjectId;
            window.location.href = `/attendance/detail/${subjectId}`;
        });
    });

    // 출석률 계산 방식 모달 열기/닫기
    const modal = document.getElementById('calculation-modal');
    const showModalBtn = document.getElementById('show-calculation-modal');
    const closeModalBtns = document.getElementById('close-calculation-modal');
    const closeModalBtn = document.getElementById('close-calculation-modal-btn');

    if (showModalBtn) {
        showModalBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });
    }

    if (closeModalBtns) {
        closeModalBtns.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }

    // 모달 배경 클릭 시 닫기
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}
