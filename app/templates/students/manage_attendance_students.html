{% extends "base.html" %}

{% block title %}ì¶œì„ ê´€ë¦¬ - WCheck{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='attendance_cards.css') }}">
{% endblock %}

{% block header %}
<header class="full-title-header">
    <div class="title-wrap">
        <h1 class="page-title">{{ username }}ë‹˜ ì¶œì„ ê´€ë¦¬</h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="hint alert alert-info">
        <span>ğŸ’¡</span>
        <span>ê³¼ëª©ë³„ ì¶œì„ í˜„í™©ì„ í™•ì¸í•˜ê³ , ìƒì„¸ ë‚´ì—­ì„ ë³´ë ¤ë©´ ì¹´ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”.</span>
    </div>
    <div class="attendance-calculation-hint">
        <span class="calculation-link" id="show-calculation-modal">
            ğŸ“Š ì¶œì„ë¥  ê³„ì‚° ë°©ì‹
        </span>
    </div>

    <!-- ì¶œì„ë¥  ê³„ì‚° ë°©ì‹ ëª¨ë‹¬ -->
    <div id="calculation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“Š ì¶œì„ë¥  ê³„ì‚° ë°©ì‹</h2>
                <button class="modal-close" id="close-calculation-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calculation-formula">
                    <h3>ê³„ì‚° ê³µì‹</h3>
                    <div class="formula-box">
                        ì¶œì„ë¥  = <span class="formula-numerator">(ì¶œì„ + ì§€ê°)</span> / <span class="formula-denominator">ì‹¤ì œ ì§„í–‰ëœ ìˆ˜ì—… (íœ´ê°• ì œì™¸)</span> Ã— 100%
                    </div>
                </div>
                <div class="calculation-explanation">
                    <h3>ì„¤ëª…</h3>
                    <ul class="explanation-list">
                        <li><strong>ì¶œì„ë¥ ì€ ì˜¤ëŠ˜ê¹Œì§€ ì§„í–‰ëœ ìˆ˜ì—… ê¸°ì¤€</strong>ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
                        <li><strong>ì§€ê°ë„ ì¶œì„ìœ¼ë¡œ ê°„ì£¼</strong>ë©ë‹ˆë‹¤.</li>
                        <li><strong>íœ´ê°• ìˆ˜ì—…ì€ ì¶œì„ë¥  ê³„ì‚°ì—ì„œ ì œì™¸</strong>ë©ë‹ˆë‹¤.</li>
                        <li><strong>ì¶œì„ ê¸°ë¡ì´ ì—†ëŠ” ìˆ˜ì—…ì€ ê²°ì„ìœ¼ë¡œ ê°„ì£¼</strong>ë©ë‹ˆë‹¤.</li>
                        <li><strong>ë¶„ëª¨ëŠ” ì‹¤ì œë¡œ ì§„í–‰ëœ ìˆ˜ì—…ë§Œ í¬í•¨</strong>ë©ë‹ˆë‹¤ (íœ´ê°• ì œì™¸).</li>
                    </ul>
                </div>
                <div class="calculation-example">
                    <h3>ì˜ˆì‹œ</h3>
                    <div class="example-box">
                        <p>ì˜¤ëŠ˜ê¹Œì§€ ì§„í–‰ëœ ìˆ˜ì—…: 10ê°œ (íœ´ê°• 1ê°œ í¬í•¨)</p>
                        <p>ì‹¤ì œ ì§„í–‰ëœ ìˆ˜ì—…: 9ê°œ (íœ´ê°• ì œì™¸)</p>
                        <p>ì¶œì„: 5ê°œ, ì§€ê°: 2ê°œ, ê²°ì„: 1ê°œ, ì¶œì„ê¸°ë¡ì—†ìŒ: 1ê°œ</p>
                        <p class="example-result">
                            ì¶œì„ë¥  = (5 + 2) / 9 Ã— 100% = 7 / 9 Ã— 100% = <strong>77.8%</strong>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-close" id="close-calculation-modal-btn">í™•ì¸</button>
            </div>
        </div>
    </div>

    {% if enrolled_subjects %}
        <div class="attendance-cards-container fade-in">
            {% for subject in enrolled_subjects %}
                <div class="attendance-card status-{{ 'safe' if subject.status_color == 'green' else 'warning' if subject.status_color == 'orange' else 'danger' }} clickable-row" 
                     data-subject-id="{{ subject.subject_id }}">
                    <div class="card-header">
                        <h3 class="card-subject-name">{{ subject.subject_name }}</h3>
                        <p class="card-professor-name">{{ subject.professor_name or 'êµìˆ˜ ì •ë³´ ì—†ìŒ' }}</p>
                    </div>
                    <div class="card-body">
                        <div class="card-percentage">
                            <span class="card-percentage-value">{{ subject.attendance_percentage }}</span>
                            <span class="card-percentage-unit">%</span>
                            <span class="card-status-badge">{{ subject.status_text }}</span>
                        </div>
                        <div class="card-progress-container">
                            <div class="card-progress-bar">
                                <div class="card-progress-fill" style="width: {{ subject.attendance_percentage }}%;"></div>
                            </div>
                            <div class="card-stats">
                                <div class="card-stat-item">
                                    <span class="card-stat-label">ì¶œì„</span>
                                    <span class="card-stat-value">{{ subject.present_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">ì§€ê°</span>
                                    <span class="card-stat-value">{{ subject.late_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">ê²°ì„</span>
                                    <span class="card-stat-value">{{ subject.absent_count }}</span>
                                </div>
                                <div class="card-stat-item">
                                    <span class="card-stat-label">ì´ ìˆ˜ì—…</span>
                                    <span class="card-stat-value">{{ subject.total_sessions }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state card">
            <p class="empty-message">ìˆ˜ê°• ì¤‘ì¸ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.clickable-row').forEach(card => {
        card.addEventListener('click', () => {
            const subjectId = card.dataset.subjectId;
            window.location.href = `/attendance/detail/${subjectId}`;
        });
    });

    // ì¶œì„ë¥  ê³„ì‚° ë°©ì‹ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    const modal = document.getElementById('calculation-modal');
    const showModalBtn = document.getElementById('show-calculation-modal');
    const closeModalBtns = document.getElementById('close-calculation-modal');
    const closeModalBtn = document.getElementById('close-calculation-modal-btn');

    if (showModalBtn) {
        showModalBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });
    }

    if (closeModalBtns) {
        closeModalBtns.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}
